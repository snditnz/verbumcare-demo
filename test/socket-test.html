<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VerbumCare Nagare - Socket.IO Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #667eea;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-left: 10px;
    }

    .status-disconnected {
      background: #fee;
      color: #c33;
    }

    .status-connected {
      background: #efe;
      color: #3c3;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #555;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: #667eea;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }

    .btn:hover {
      background: #5568d3;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .progress-container {
      margin-top: 20px;
      display: none;
    }

    .progress-container.active {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    .progress-message {
      font-size: 14px;
      color: #666;
      text-align: center;
    }

    .log {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
    }

    .log-entry {
      padding: 6px 0;
      border-bottom: 1px solid #e8e8e8;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #999;
      font-size: 11px;
      margin-right: 8px;
    }

    .log-event {
      color: #667eea;
      font-weight: 600;
      margin-right: 8px;
    }

    .log-data {
      color: #333;
    }

    .results {
      margin-top: 20px;
      display: none;
    }

    .results.active {
      display: block;
    }

    .results pre {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      border: 1px solid #e0e0e0;
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• VerbumCare Nagare</h1>
      <p>Real-Time Voice Processing Monitor (Socket.IO Test)</p>
    </div>

    <!-- Connection Status -->
    <div class="card">
      <h2>
        Connection Status
        <span id="status-badge" class="status-badge status-disconnected">Disconnected</span>
      </h2>
      <div class="form-group">
        <label>Server URL (mDNS: https://nagare.local)</label>
        <input type="text" id="server-url" value="https://nagare.local" placeholder="https://nagare.local">
      </div>
      <button class="btn" id="connect-btn" onclick="connect()">Connect</button>
    </div>

    <!-- File Upload & Process -->
    <div class="card">
      <h2>Voice Recording Upload</h2>

      <div class="grid">
        <div class="form-group">
          <label>Patient ID (UUID)</label>
          <input type="text" id="patient-id" value="550e8400-e29b-41d4-a716-446655440201">
        </div>
        <div class="form-group">
          <label>Recorded By (UUID)</label>
          <input type="text" id="nurse-id" value="550e8400-e29b-41d4-a716-446655440101">
        </div>
      </div>

      <div class="form-group">
        <label>Audio File</label>
        <input type="file" id="audio-file" accept="audio/*">
      </div>

      <button class="btn" id="upload-btn" onclick="uploadAndProcess()" disabled>
        Upload & Process
      </button>

      <div id="progress" class="progress-container">
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill">0%</div>
        </div>
        <div id="progress-message" class="progress-message">Initializing...</div>
      </div>

      <div id="results" class="results">
        <h3 style="margin-bottom: 12px;">Results</h3>
        <pre id="results-data"></pre>
      </div>
    </div>

    <!-- Event Log -->
    <div class="card">
      <h2>Event Log</h2>
      <div id="event-log" class="log">
        <div class="log-entry">
          <span class="log-time">--:--:--</span>
          <span class="log-event">SYSTEM</span>
          <span class="log-data">Waiting for connection...</span>
        </div>
      </div>
      <button class="btn" onclick="clearLog()" style="margin-top: 12px; background: #999;">
        Clear Log
      </button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    let socket = null;
    let currentRecordingId = null;

    // UI Elements
    const statusBadge = document.getElementById('status-badge');
    const connectBtn = document.getElementById('connect-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const serverUrl = document.getElementById('server-url');
    const eventLog = document.getElementById('event-log');
    const progressContainer = document.getElementById('progress');
    const progressFill = document.getElementById('progress-fill');
    const progressMessage = document.getElementById('progress-message');
    const resultsContainer = document.getElementById('results');
    const resultsData = document.getElementById('results-data');

    function log(event, data) {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-event">${event}</span>
        <span class="log-data">${data}</span>
      `;
      eventLog.insertBefore(entry, eventLog.firstChild);
    }

    function clearLog() {
      eventLog.innerHTML = '';
      log('SYSTEM', 'Log cleared');
    }

    function updateStatus(connected) {
      statusBadge.textContent = connected ? 'Connected' : 'Disconnected';
      statusBadge.className = `status-badge ${connected ? 'status-connected' : 'status-disconnected'}`;
      uploadBtn.disabled = !connected;
    }

    function connect() {
      const url = serverUrl.value;

      if (socket) {
        socket.disconnect();
        socket = null;
        updateStatus(false);
        connectBtn.textContent = 'Connect';
        log('DISCONNECT', 'Manually disconnected');
        return;
      }

      log('CONNECTING', `Connecting to ${url}...`);
      connectBtn.textContent = 'Connecting...';
      connectBtn.disabled = true;

      socket = io(url, {
        rejectUnauthorized: false,
        transports: ['websocket', 'polling']
      });

      socket.on('connect', () => {
        log('CONNECT', `Connected to ${url}`);
        log('INFO', `Socket ID: ${socket.id}`);
        updateStatus(true);
        connectBtn.textContent = 'Disconnect';
        connectBtn.disabled = false;
      });

      socket.on('disconnect', (reason) => {
        log('DISCONNECT', `Disconnected: ${reason}`);
        updateStatus(false);
        connectBtn.textContent = 'Connect';
        connectBtn.disabled = false;
        socket = null;
      });

      socket.on('connect_error', (error) => {
        log('ERROR', `Connection error: ${error.message}`);
        updateStatus(false);
        connectBtn.textContent = 'Connect';
        connectBtn.disabled = false;
        socket = null;
      });

      // Voice processing progress events
      socket.on('voice-processing-progress', (data) => {
        log('PROGRESS', `${data.recording_id.substring(0, 8)}... - ${data.phase} - ${data.message}`);

        if (data.recording_id === currentRecordingId) {
          handleProgressUpdate(data);
        }
      });

      // Generic event listener for debugging
      socket.onAny((eventName, ...args) => {
        if (eventName !== 'voice-processing-progress') {
          log('EVENT', `${eventName}: ${JSON.stringify(args)}`);
        }
      });
    }

    function handleProgressUpdate(data) {
      progressContainer.classList.add('active');

      // Update progress bar
      const progress = data.progress || 0;
      progressFill.style.width = `${progress}%`;
      progressFill.textContent = `${progress}%`;

      // Update message
      progressMessage.textContent = data.message || data.phase || 'Processing...';

      // Handle completion
      if (data.status === 'completed') {
        progressFill.style.background = 'linear-gradient(90deg, #3c3, #2a2)';
        progressMessage.textContent = '‚úÖ Processing complete!';

        // Show results
        resultsContainer.classList.add('active');
        resultsData.textContent = JSON.stringify(data.data, null, 2);

        log('SUCCESS', `Processing completed in ${
          ((new Date(data.data.recording.processing_completed_at) -
            new Date(data.data.recording.processing_started_at)) / 1000).toFixed(1)
        }s`);
      }

      // Handle failure
      if (data.status === 'failed') {
        progressFill.style.background = 'linear-gradient(90deg, #c33, #a11)';
        progressMessage.innerHTML = `<span class="error">‚ùå Processing failed: ${data.error}</span>`;
        log('ERROR', `Processing failed: ${data.error}`);
      }
    }

    async function uploadAndProcess() {
      const fileInput = document.getElementById('audio-file');
      const patientId = document.getElementById('patient-id').value;
      const nurseId = document.getElementById('nurse-id').value;

      if (!fileInput.files[0]) {
        alert('Please select an audio file');
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';
      progressContainer.classList.remove('active');
      resultsContainer.classList.remove('active');

      try {
        // Step 1: Upload
        log('UPLOAD', 'Uploading audio file...');
        const formData = new FormData();
        formData.append('audio', fileInput.files[0]);
        formData.append('patient_id', patientId);
        formData.append('recorded_by', nurseId);

        const uploadResponse = await fetch(`${serverUrl.value}/api/voice/upload`, {
          method: 'POST',
          body: formData
        });

        if (!uploadResponse.ok) {
          throw new Error(`Upload failed: ${uploadResponse.statusText}`);
        }

        const uploadData = await uploadResponse.json();
        currentRecordingId = uploadData.data.recording_id;

        log('SUCCESS', `Uploaded: ${currentRecordingId}`);

        // Step 2: Start processing
        uploadBtn.textContent = 'Processing...';
        log('PROCESS', 'Starting AI processing...');

        const processResponse = await fetch(`${serverUrl.value}/api/voice/process`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recording_id: currentRecordingId })
        });

        if (!processResponse.ok) {
          throw new Error(`Process failed: ${processResponse.statusText}`);
        }

        const processData = await processResponse.json();
        log('SUCCESS', `Processing started: ${processData.status_url}`);
        log('INFO', 'Listening for real-time updates via Socket.IO...');

        uploadBtn.textContent = 'Upload & Process';

      } catch (error) {
        console.error('Upload/Process error:', error);
        log('ERROR', error.message);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = `Error: ${error.message}`;
        progressContainer.insertAdjacentElement('afterend', errorDiv);
        uploadBtn.textContent = 'Upload & Process';
      } finally {
        uploadBtn.disabled = false;
      }
    }

    // Initialize
    log('SYSTEM', 'Socket.IO test client loaded');
    log('INFO', 'Click "Connect" to start');
  </script>
</body>
</html>
